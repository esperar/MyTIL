# 애그리거트와 트랜잭션 관리

## 애그리거트와 트랜잭션

> 두 사용자가 한 애그리거트를 동시에 변경할 때 일관성이 깨지게 된다.

![](https://camo.githubusercontent.com/1124c1bd5bbab6af788f0aa4c2830cc5a178271920961ad103b3fea7af7bbbb1/68747470733a2f2f333535333234383434362d66696c65732e676974626f6f6b2e696f2f7e2f66696c65732f76302f622f676974626f6f6b2d6c65676163792d66696c65732f6f2f6173736574732532462d4d35484f53747876782d4a723066715a6879572532462d4d43766b674932366a743949326d36793079332532462d4d43766c592d337357304a62645a6364664575253246382e312e706e673f616c743d6d6564696126746f6b656e3d35643530633832322d383830632d343065322d386232652d613963336330356665613365)

한 애그리거트를 두 사용자가 동시에 변경할 때 트랜잭션이 필요하다.   
운영자 스레드와 고객 스레드는 개념적으로 동일한 애그리거트지만 물리적으로 서로 다른 애그리거트 객체를 사용한다.  
이 상황에서 두 스레드는 각각 트랜잭션을 커밋할 때 수정한 내용을 DB에 반영한다.  
이 때, 애그리거트의 `일관성`이 깨지게된다.
  
일관성이 깨지는 것을 막기 위해 다음 두 가지 중 하나를 해야한다.
- 운영자가 배송지 정보를 조회하고 상태를 변경하는 동안, 고객이 애그리거트를 수정하지 못하게 막는다.
- 운영자가 배송지 정보를 조회한 이후 고객의 정보를 변경하면, 운영자 애그리거트를 다시 조회한 뒤 수정하도록 한다.

DBMS가 지원하는 트랜잭션과 함께 애그리거트를 위한 추가적인 트랜잭션 기법으로 선점(비관적) 잠금과 비선점(낙관적) 잠금이 있다.

## 선점 잠금
> 선점 잠금은 교착 상태에 빠질 위험이 있다.

선점 잠금은 **먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식**이다.  

![](https://camo.githubusercontent.com/e2826dc4a36497e2545e5170e64871108ea2b23a0994516b61b920b68be8d83f/68747470733a2f2f333535333234383434362d66696c65732e676974626f6f6b2e696f2f7e2f66696c65732f76302f622f676974626f6f6b2d6c65676163792d66696c65732f6f2f6173736574732532462d4d35484f53747876782d4a723066715a6879572532462d4d43766b674932366a743949326d36793079332532462d4d43766c5f632d615534446767666e64693461253246382e322e706e673f616c743d6d6564696126746f6b656e3d38663735303930392d353362352d346638342d613134302d663439363064663163326135)

스레드2는 스레드 1이 애그리거트에 대한 잠금을 해제할 때까지 블로킹이 된다.  
스레드1이 트랜잭션을 커밋한 뒤에 스레드2가 애그리거트를 구하게 되므로 스레드2는 스레드1이 수정한 애그리거트의 내용을 보게된다.  
선점 잠금은 보통 DBMS가 제공하는 행단위 잠금ㅇㄹ 사용한다.  
for update와 같은 쿼리를 사용해 특정 레코드에 한 커넥션만 접근할 수 있는 잠금장치를 제공한다.  
스프링 데이터 JPA는 @Lock 어노테이션을 사용해 잠금 모드를 지정한다.  
하이버네이트는 PESSIMISTIC_WRITE를 잠금 모드로 사용하면 for update 쿼리를 이용한다.

### 선점 잠금과 교착 상태
> 교착 상태를 주의해야 한다.

사용자 수가 많아질수록 교착 상태에 빠지는 스레드가 증가하고, 시스템은 아무것도 할 수 없는 상태가 된다.  
이를 방지하기 위해 잠금을 구할 때 최대 대기 시간을 지정해야 한다.  
javax.persistence.lock.timeout 힌트는 잠금을 구하는 대기 시간을 밀리초 단위로 지정해 예외를 발생시킨다.  
DBMS에 따라 힌트가 적용되지 않을 수 있기 때문에 관련 기능을 지원하는지 확인해야 한다.  
스프링 데이터 JPA는 @QueryHints 어노테이션을 사용해 쿼리 힌트를 지정할 수 있다.

