# Process Memory Structure

### 프로그램 실행

프로그램의 실행은 두 가지 중요한 의미를 가진다
1. 파일 시스템에 존재하던 실행 파일이 메모리에 적재된다는 의미
2. 프로그램 CPU를 할당 받고 명령을 수행하고 있는 상태

파일 시스템에 있는 실행 파일에 메모리에 적재될 때, 실행파일 전체가 메모리에 올라가지 않는다. 일부분만 메모리에 올라가고 나머지는 디스크의 특정 영역인 **스왑 영역**에 존재한다.


### 프로세스 메모리 영역

프로세스의 주소 공간은 Code, Data, Stack, Heap 영역으로 구성된다


이러한 주소 공간을 우리는 가상 메모리 또는 논리적 메모리라고 부른다.

#### Code Area

**사용자가 작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령 형태로 변환되어 저장되는 공간**이다. 컴파일 타임에 결정되고 중간에 코드를 바꿀 수 없어 Read-Only로 되어있다.


#### Data Area

**전역 변수 또는 static 변수 등 프로그램이 사용하는 데이터를 저장하는 공간**이다. 전역 변수 또는 static 값을 참조한 코드는 컴파일이 완료되면 data 영역의 주소값을 가르키도록 한다. 전역변수가 변경될 수도 있어 Read-Write로 되어 있다.

#### Stack Area

**호출된 함수의 수행을 마치고 복귀할 주소 및 데이터(지역변수, 매개변수, 리턴값)를 임시로 저장하는 공간이다.**

이 영역은 함수 호출시 기록하고 함수의 수행이 완료되면 사라진다. 메커니즘은 자료구조 stack에서 배운 LIFO 방법을 따른다. 

컴파일시 stack 영역의 크기가 결정되기 때문에 무한정 할당 할 수 없다. 따라서 재귀 함수가 반복해서 호출되거나 함수가 지역변수를 메모리가 초과할정도로 많이 가지고 있다면 stack overflow가 발생한다.


#### Heap Area

**프로그래머가 필요할 때마다 사용하는 동적데이터를 담는 메모리 영역**

heap 영역은 런타임에 결정된다. 자바에서 객체가 heap 영역에 생성되고 gc에 의해서 정리된다.

<br>

### 커널 주소 공간

운영체제도 하나의 프로세스이기 때문에 커널 역시 동일한 주소 공간인 code, data, stack 영역을 갖는다.

코드 영역은 시스템 콜, 인터럽트 처리 코드, cpu, memory 등 자원 관리를 위한 코드, 편리한 인터페이스 제공을 위한 코드들이 담겨있다.

데이터 영역은 PCB(Process Control Block)이라는 현재 수행중인 프로세스의 상태, cpu 사용률을 유지하기 위한 자료구조와 cpu, memory 등 하드웨어 자원을 관리하기 위한 자료구조가 저장되어 있다.

스택 앵역에는 각 프로세스의 커널 스택을 저장하고 프로세스는 함수 호출시 자신의 복구 주소를 저장하지만 커널은 커널 내의 주소가 된다. 각각의 프로세스마다 별도의 스택을 두어 관리한다.

#### 커널은 힙 메모리가 없는가?

커널은 Linux 운영체제의 주요 구성 요소이며 컴퓨터 하드웨어와 프로세스를 잇는 핵심 **인터페이스다.** 그리고 두 가지 관리 리소스에서 최대한 효과적으로 통신한다.

커널 == 운영체제가 아니라 커널은 운영체제의 주요 구성 요소로 리눅스로 예를 들어 설명하면 커널은 메모리 관리, 프로세스 관리, 하드웨어와 프로세스 사이에서 인터프리터 역할을 수행하거나 시스템의 호출이나 보안등의 기능을 수행한다. 즉, 리눅스에서 **커널은 하나의 프로세스가 아니라 컴퓨터 하드웨어와 프로세스를 잇는 인터페이스로 보아야한다.**

커널은 힙메모리를 사용하지 않는다. 커널은 운영체제에서 동적 메모리를 할당을 하기위해 필요한 기능들이 커널에서 제공하는데, 운영체제는 커널에서 제공하는 기능을 사용해서 메모리 풀을 관리한다.